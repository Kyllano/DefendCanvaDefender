<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Fingerprinting</title>
    <script src="fp.js"></script>
</head>

<body>
    <h1>Canvas Fingerprinting</h1>
    <p id="fingerprint"></p>

    <script>
        // Crée une instance de la classe Fingerprint
        const fingerprint = new Fingerprint();

        // Définit l'observateur de mutation pour détecter le vecteur de bruit
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                console.log(mutation.addedNodes);
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    const addedNode = mutation.addedNodes[0];
                    if (addedNode.nodeName === 'SCRIPT' && addedNode.textContent.includes('overrideDefaultMethods')) {
                        const noiseMatch = addedNode.textContent.match(/\d{1,2},\d{1,2},\d{1,2},\d{1,2}/);
                        // var noise = ['26', '9', '13', '27'] R G B A 
                        // pour extraire il faut enlever a chaque pixel le bruit rajouter
                        // la valeur par defaut d'un pixel est 0
                        if (noiseMatch) {
                            const noise = noiseMatch[0].split(',').map(Number);
                            const canvasFingerprint = fingerprint.getCanvasFingerprint(noise);
                            document.getElementById('fingerprint').innerText = `Canvas Fingerprint: ${canvasFingerprint}`;

                            // Envoie la fingerprint et le vecteur de bruit au serveur
                            fetch('/fetch', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    fingerprint: canvasFingerprint,
                                    noise: noise,
                                }),
                            })
                                .then(response => response.json())
                                .then(data => console.log(data))
                                .catch((error) => console.error('Error:', error));
                        }
                    }
                }
            });
        });

        // Observe les modifications dans le document
        observer.observe(document, { childList: true, subtree: true });

        // Crée un canvas et obtient sa fingerprint
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = 200;
        canvas.height = 100;

        ctx.font = '20px Arial';
        ctx.fillText('Hello, World!', 10, 50);

        const canvasFingerprint = fingerprint.getCanvasFingerprint();
        document.getElementById('fingerprint').innerText = `Canvas Fingerprint: ${canvasFingerprint}`;
    </script>
</body>

</html